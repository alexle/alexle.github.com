<!-- post template -->
<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="utf-8">
   <meta name="google-site-verification" content="UNRfpImcRQ3BIYIbiTDAv7O_9dJy-L3rcmWchHTi_Vc" />
   <meta name="msvalidate.01" content="8F7A5DB489A40721CBADB9FED30E8A1D" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <meta name="description" content="Alex's blog on software, running, and life in general." />
   <title>Sending Netflix OAuth Requests With Python | Alex Le</title>

   <!-- Google Analytics -->
   <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-28947728-1']);
      _gaq.push(['_trackPageview']);

      (function() {
         var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
         ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
         var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
   </script>

   <!-- Pure -->
   <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
   <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">

   <!-- Javascript and Stylesheets -->
   <script type="text/javascript" src="https://apis.google.com/js/plusone.js" async defer></script>
   <script type="text/javascript" src="/css/prism.js"></script>
   <link rel="stylesheet" type="text/css" href="/css/blog.css">
   <link rel="stylesheet" type="text/css" href="/css/prism.css">
   <link rel="alternate" type="application/rss+xml" title="RSS" href="http://alexanderle.com/rss.xml">

   <!-- Fonts -->
   <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
</head>

<body>
<div id="wrapper" class="pure-g">
   <!-- SIDEBAR MENU -->
   <div class="sidebar pure-u-1 pure-u-md-1-5">
      <a href="#menu" id="menuLink" class="menu-link">
         <!-- Hamburger icon -->
      <span></span>
      <a href="/"><img src="/static/alex_le_profile.jpg" alt="alex le" class="profile-pic"></a>
      <h1 class="brand-title">Alex Le</h1>

      <nav class="nav">
         <ul class="nav-list">
            <li class="nav-item">
               <a class="pure-button" href="/about.html">ABOUT</a>
            </li>
            <li class="nav-item">
               <a class="pure-button" href="/blog/archives.html">BLOG</a>
            </li>
         </ul>
      </nav>
   </div> <!-- end sidebar -->

   <div class="content pure-u-1 pure-u-md-4-5">
      <!-- MAIN CONTENT -->
      <article>
         
<div class="post">
   <div class="post-title">
      <h1 class="post-title-link">Sending Netflix OAuth Requests With Python</h1>
   </div>

   <div class="post-date">
      Feb 24, 2013
   </div>

   <p class="post-content">
      <p>Oauth is an authentication protocol that allows users to grant a third-party access to their resources - without sharing their password. Kind of similar to creating a temporary key to your car for someone, a key which can have chosen limitations and be disabled at any time. Great for users. Confusing for newbies like me working with it.</p>
<p>That's because each service can have a different method to "hand-shake" between the user and consumer. In a previous <a href="/blog/2012/neatflix-my-netflix-api-demo.html">post</a>, I shared a <a href="http://neatflix.appspot.com/">demo</a> that uses the Netflix API. It was my first experience with Oauth and it took me a while to understand all the nuances involved. Here, I'll detail how I sent non-authenticated and authenticated signed requests to Netflix with Python.</p>
<h2>Before You Start</h2>
<ol>
<li>Register your application at <a href="http://developer.netflix.com/apps/register/">http://developer.netflix.com/apps/register/</a>. A unique consumer key and secret is provided to you afterwards. Keep this for later.</li>
<li>Go over the Netflix <a href="http://developer.netflix.com/docs/Security">Authentication Overview</a>. This contains all the required info to make Netflix API requests. It also has nice information containing common REST API tasks you can send.</li>
</ol>
<h2>Performing A Non-Authenticated Request</h2>
<p>The "autocomplete catalog" request searches the Netflix catalog for movies and tv shows that partially match the search string. It's a <em>non-authenticated</em> request and only requires the consumer key and a percent-encoded search string. The format of the request is as follows:</p>
<pre><code class=language-html>http://api-public.netflix.com/catalog/titles/autocomplete?oauth_consumer_key=CONSUMER_KEY&term=SEARCH_STRING
</code></pre>

<p>To fetch the data in Python, the urllib library is used to send the request, created from the base URL and parameters:</p>
<pre><code class=language-python>import urllib
from xml.etree import ElementTree as ET

auto_url = "http://api-public.netflix.com/catalog/titles/autocomplete"

auto_parameters = [
     ('term', search_string),
     ('oauth_consumer_key', CONSUMER_KEY)]

full_auto_url = auto_url + '?' + urllib.urlencode(auto_parameters)

# Read autocomplete url
auto_data = urllib.urlopen(full_auto_url)
</code></pre>

<p>Extracting the Netflix data returned can be done by converting the XML response to an Element Object with the ElementTree library. Once in this tree-format, it can be traversed and parsed with the built-in functions:</p>
<pre><code class=language-python>auto_xml = ET.fromstring(auto_data)

# Grab all titles from autocomplete search
for i in auto_xml.findall('.//title'):
     names = i.attrib.get('short')
</code></pre>

<h2>Performing An Authenticated Signed Request</h2>
<p>The "catalog titles" search returns detailed information on a film and is an example of an <em>authenticated signed</em> request. It involves 4 steps prior to sending the request:</p>
<ol>
<li>Setting the base URL</li>
<li>Gathering the parameters</li>
<li>Creating the base string</li>
<li>Calculating the signature </li>
</ol>
<p>Combining these components produces the signed request, which has the format below:</p>
<pre><code class=language-html>http://api-public.netflix.com/PATH?parameter=PARM&oauth_consumer_key=CONSUMER_KEY&oauth_nonce=NONCE&oauth_signature_method=HMAC-SHA1&oauth_timestamp=TIME_STAMP&oauth_version=1.0&oauth_signature=SIGNATURE
</code></pre>

<p>While this may look daunting, it's not too bad once broken down. First, decide what Netflix resource you want to access (catalog/people, users/current, etc). In this example, we want more information on a particular title so we use the catalog/titles resource. The base URL thus looks like:</p>
<pre><code class=language-html>TITLE_URL = 'http://api-public.netflix.com/catalog/titles'
</code></pre>

<p>Second, we gather the required OAuth parameters for the Netflix request. </p>
<ul>
<li>
<p><strong>parm</strong> - Optional parameter(s) that specify what data is returned. For the catalog titles search, we use the "term" parameter along with the movie/tv's title to gather the film's details.</p>
</li>
<li>
<p><strong>consumer_key</strong> - Your application's consumer key.</p>
</li>
<li>
<p><strong>nonce</strong> - Random string of characters to distinguish each request from one another.</p>
</li>
<li>
<p><strong>oauth_method</strong> - This is always HMAC-SHA1.</p>
</li>
<li>
<p><strong>time_stamp</strong> - Number of seconds since epoch (Jan 1st, 1970).</p>
</li>
<li>
<p><strong>oauth_version</strong> - This is 1.0 for now.</p>
</li>
</ul>
<p>Although not required for the base string, we'll later need the parameters to be in alphabetical order, so it's easier to keep them in order from the start. </p>
<pre><code class=language-python>from hashlib import sha1
import hmac, binascii, urllib, time, string, random

def RandomString( size=6, chars=string.ascii_uppercase + string.digits ):
   return ''.join( random.choice(chars) for x in range(size) )

expand_parms = 'synopsis,cast,formats,@episodes,@seasons'
nonce = RandomString()
time_stamp = time.time()

parameters = [
   ('expand', expand_parms),
   ('max_results', '1'),
   ('oauth_consumer_key', CONSUMER_KEY),
   ('oauth_nonce', nonce),
   ('oauth_signature_method', 'HMAC-SHA1'),
   ('oauth_timestamp', time_stamp),
   ('oauth_version', '1.0'),
   ('term', term)]
</code></pre>

<p>Next, we create the base string by joining the HTTP method (GET/POST), base URL, and parameters (all percent-encoded):</p>
<pre><code class=language-python># Put together base string
param_encode = urllib.urlencode(parameters).replace('+', '%20')

base_string = 'GET&' + OAuthEscape( TITLE_URL ) + '&' + OAuthEscape(param_encode)
</code></pre>

<p>The last piece of data to collect is the signature of the base string. This is calculated by passing your consumer <strong>secret</strong> and the base string to the HMAC-SHA1 hashing algorithm. Also, the result of the HMAC function needs to be base64 encoded, turning it from an unreadable binary string into readable characters:</p>
<pre><code class=language-python>def OAuthEscape( s ):
   return urllib.quote( s, '' )

def GenerateSig( base_string ):
   secret =  NET_SECRET + '&'
   hashed = hmac.new(secret, base_string , sha1)

signed_sig = binascii.b2a_base64(hashed.digest())[:-1]

return signed_sig

sign = GenerateSig( base_string )
</code></pre>

<p>With the base URL, parameters, and signature set up, all that's left is to combine them together and make the request: </p>
<pre><code class=language-python>parameters.append(('oauth_signature', sign))

full_url = TITLE_URL + '?' + urllib.urlencode(parameters)

# Read catalog url
title_data = urllib.urlopen(full_url)

xml = ET.fromstring(title_data)
</code></pre>

<p>This basic tutorial only brushes the surface of what the Netflix API has available. To see the original code, feel free to <a href="https://github.com/alexle/Neatflix">fork my Neatflix demo</a> from Github. Try the example above or see if you can gather data from another Netflix resource. The sky is the limit on what cool applications you can conjure up.</p>
   </p>

   <p>
      <a href="https://twitter.com/share" class="twitter-share-button" data-text="Sending Netflix OAuth Requests With Python" data-via="alextrle">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
      &nbsp;&nbsp;
      <g:plusone size="medium"></g:plusone>
      <a rel="author" href="https://plus.google.com/u/0/101315815319989778966?rel=author" title="Google+" target="_blank"></a>
      <span style="float: right;"><a href="/">&larr; back to home page</a></span>
   </p>
</div>

      </article>

      <!-- FOOTER -->
      <div class="footer">
         <div class="pure-menu pure-menu-horizontal">
            <ul class="pure-menu-list">
               <li class="pure-menu-item">
                  <a href="https://twitter.com/alextrle" title="Twitter" target="_blank" class="pure-menu-link">Twitter</a>
               </li>
               <li class="pure-menu-item">
                  <a href="https://github.com/alexle" title="Github" target="_blank" class="pure-menu-link">GitHub</a>
               </li>
               <li class="pure-menu-item">
                  <a href="http://www.strava.com/athletes/alexle" title="RSS" target="_blank" class="pure-menu-link">Strava</a>
               </li>
               <li class="pure-menu-item">
                  <a href="/rss.xml" title="RSS" target="_blank" class="pure-menu-link">RSS</a>
               </li>
               <li class="pure-menu-item">
                  <a rel="author" href="https://plus.google.com/u/0/101315815319989778966?rel=author" title="Google+" target="_blank"></a>
               </li>
            </ul>
         </div> <!-- end pure-menu -->
      </div> <!-- end footer -->

   </div> <!-- end content -->

</div> <!-- end wrapper -->

</body>
</html>